import numpy as np
import pandas as pd
from typing import Callable, Dict

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# MemoryBlock í´ë˜ìŠ¤: ì¼ë°˜ ë©”ëª¨ë¦¬ ë¸”ë¡
class MemoryBlock:
    def __init__(self, name: str, data: np.ndarray):
        self.name = name
        self.data = data

# DiskBlock í´ë˜ìŠ¤: ë””ìŠ¤í¬ íŒŒì¼ ê¸°ë°˜ ë¸”ë¡ (CSV ëŒ€ìƒ)
class DiskBlock:
    def __init__(self, name: str, path: str, column: str = None):
        self.name = name
        self.path = path  # ì˜ˆ: CSV íŒŒì¼ ê²½ë¡œ
        self.column = column  # íŠ¹ì • ì»¬ëŸ¼ë§Œ ì—°ì‚° ëŒ€ìƒìœ¼ë¡œ ì§€ì •

    def load(self) -> np.ndarray:
        df = pd.read_csv(self.path)
        if self.column:
            return df[self.column].values
        return df.values  # ì „ì²´ ë°ì´í„°ë¥¼ ndarrayë¡œ ë°˜í™˜

# Operation í´ë˜ìŠ¤: ì¶œë ¥ ë¸”ë¡, í•¨ìˆ˜, ì…ë ¥ ë¸”ë¡ ë¦¬ìŠ¤íŠ¸ í¬í•¨
class Operation:
    def __init__(self, output: str, func: Callable, inputs: list):
        self.output = output
        self.func = func
        self.inputs = inputs  # input block names

# SDOM í´ë˜ìŠ¤: ì „ì²´ ì—°ì‚° ì‹œìŠ¤í…œ
class SDOM:
    def __init__(self):
        self.mem_blocks: Dict[str, MemoryBlock] = {}
        self.disk_blocks: Dict[str, DiskBlock] = {}
        self.operations: list[Operation] = []

    # ë©”ëª¨ë¦¬ ë¸”ë¡ ë¡œë”©
    def load_data(self, name: str, data: list):
        self.mem_blocks[name] = MemoryBlock(name, np.array(data))

    # ë””ìŠ¤í¬ ë¸”ë¡ ë¡œë”©
    def load_disk_block(self, name: str, path: str, column: str = None):
        self.disk_blocks[name] = DiskBlock(name, path, column)

    # ì—°ì‚° ì •ì˜
    def define_operation(self, output: str, func: Callable, inputs: list):
        self.operations.append(Operation(output, func, inputs))

    # ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (ë©”ëª¨ë¦¬ ë˜ëŠ” ë””ìŠ¤í¬)
    def get_data(self, name: str):
        if name in self.mem_blocks:
            return self.mem_blocks[name].data
        elif name in self.disk_blocks:
            return self.disk_blocks[name].load()
        else:
            raise ValueError(f"Block '{name}' not found.")

    # ì—°ì‚° ìˆ˜í–‰
    def compute(self):
        for op in self.operations:
            input_data = [self.get_data(name) for name in op.inputs]
            result = op.func(*input_data)
            self.mem_blocks[op.output] = MemoryBlock(op.output, result)

    # ê²°ê³¼ ë°˜í™˜
    def get_result(self, name: str):
        return self.get_data(name)

import pandas as pd

# ì˜ˆì œ CSV íŒŒì¼ ìƒì„±
df = pd.DataFrame({
    'value1': [1, 2, 3, 4],
    'value2': [10, 20, 30, 40]
})
df.to_csv('data.csv', index=False)


# SDOM ì‹œìŠ¤í…œ ì´ˆê¸°í™”
sdom = SDOM()

# ë””ìŠ¤í¬ì— ìˆëŠ” CSV ì»¬ëŸ¼ ë¶ˆëŸ¬ì˜¤ê¸°
sdom.load_disk_block('A', 'data.csv', column='value1')
sdom.load_disk_block('B', 'data.csv', column='value2')

# ì—°ì‚° ì •ì˜: C = A + B
sdom.define_operation('C', lambda a, b: a + b, ['A', 'B'])

# ì—°ì‚° ìˆ˜í–‰
sdom.compute()

# ê²°ê³¼ ì¶œë ¥
print("C =", sdom.get_result('C'))



import numpy as np
import pandas as pd
from typing import Callable, Dict
import math

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# MemoryBlock: ë©”ëª¨ë¦¬ ê¸°ë°˜ ë¸”ë¡
class MemoryBlock:
    def __init__(self, name: str, data: np.ndarray):
        self.name = name
        self.data = data

# DiskBlock: CSV ì»¬ëŸ¼ì„ ì—°ì‚° ë¸”ë¡ìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” ë¸”ë¡
class DiskBlock:
    def __init__(self, name: str, path: str, column: str = None):
        self.name = name
        self.path = path
        self.column = column

    def load(self) -> np.ndarray:
        df = pd.read_csv(self.path)
        if self.column:
            return df[self.column].values
        return df.values

# Operation: ì—°ì‚° ì •ì˜
class Operation:
    def __init__(self, output: str, func: Callable, inputs: list):
        self.output = output
        self.func = func
        self.inputs = inputs

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# SDOM ê³„ì‚°ê¸°: ë©”ëª¨ë¦¬ + ë””ìŠ¤í¬ ì—°ì‚°ì„ í†µí•© ì§€ì›
class SDOMCalculator:
    def __init__(self):
        self.mem_blocks: Dict[str, MemoryBlock] = {}
        self.disk_blocks: Dict[str, DiskBlock] = {}
        self.operations: list[Operation] = []

    def load_memory(self, name: str, data: list):
        self.mem_blocks[name] = MemoryBlock(name, np.array(data))

    def load_disk(self, name: str, path: str, column: str = None):
        self.disk_blocks[name] = DiskBlock(name, path, column)

    def define_operation(self, output: str, func: Callable, inputs: list):
        self.operations.append(Operation(output, func, inputs))

    def get_data(self, name: str):
        if name in self.mem_blocks:
            return self.mem_blocks[name].data
        elif name in self.disk_blocks:
            return self.disk_blocks[name].load()
        else:
            raise ValueError(f"âŒ ë¸”ë¡ '{name}' ì—†ìŒ")

    def compute(self):
        for op in self.operations:
            input_data = [self.get_data(name) for name in op.inputs]
            result = op.func(*input_data)
            self.mem_blocks[op.output] = MemoryBlock(op.output, result)

    def get_result(self, name: str):
        return self.get_data(name)

    def list_blocks(self):
        return list(self.mem_blocks.keys()) + list(self.disk_blocks.keys())

    def clear_operations(self):
        self.operations = []



def run_calculator():
    calc = SDOMCalculator()
    print("\nğŸ§  SDOM ê³„ì‚°ê¸° ì‹œì‘: ë©”ëª¨ë¦¬ + ë””ìŠ¤í¬ ì—°ì‚° ì§€ì› (ì¢…ë£Œí•˜ë ¤ë©´ 'exit')\n")

    while True:
        cmd = input("ëª…ë ¹ (load, load_disk, op, run, show, list, clear, exit): ").strip()

        if cmd == "exit":
            print("ğŸ‘‹ ì¢…ë£Œí•©ë‹ˆë‹¤.")
            break

        elif cmd == "load":
            name = input("ë¸”ë¡ ì´ë¦„: ")
            values = input("ë°ì´í„° (ì‰¼í‘œë¡œ êµ¬ë¶„): ")
            data = [float(x) for x in values.split(',')]
            calc.load_memory(name, data)
            print(f"âœ… ë©”ëª¨ë¦¬ ë¸”ë¡ '{name}' ë¡œë”© ì™„ë£Œ.")

        elif cmd == "load_disk":
            name = input("ë¸”ë¡ ì´ë¦„: ")
            path = input("CSV ê²½ë¡œ: ")
            column = input("ì»¬ëŸ¼ ì´ë¦„ (ì „ì²´ëŠ” ë¹ˆì¹¸): ").strip()
            column = column if column else None
            calc.load_disk(name, path, column)
            print(f"âœ… ë””ìŠ¤í¬ ë¸”ë¡ '{name}' â†’ íŒŒì¼ '{path}' ì»¬ëŸ¼ '{column}' ë¡œë”© ì™„ë£Œ.")

        elif cmd == "op":
            output = input("ì¶œë ¥ ë¸”ë¡ ì´ë¦„: ")
            expr = input("ìˆ˜ì‹ (ì˜ˆ: A + B, A * np.sin(B)): ")

            # ì—°ì‚°ì— ì‚¬ìš©ëœ ë¸”ë¡ ì´ë¦„ ì¶”ì¶œ
            inputs = []
            for token in expr.replace('(', ' ').replace(')', ' ').replace('*', ' ')\
                             .replace('+', ' ').replace('-', ' ').replace('/', ' ').split():
                if token.isalpha() and token in calc.list_blocks():
                    inputs.append(token)

            def safe_func(*args, expr=expr, inputs=inputs):
                local_vars = {name: arg for name, arg in zip(inputs, args)}
                local_vars['np'] = np
                local_vars['math'] = math
                return eval(expr, {"__builtins__": {}}, local_vars)

            calc.define_operation(output, safe_func, inputs)
            print(f"ğŸ§® ì—°ì‚° '{expr}' â†’ '{output}' ì •ì˜ ì™„ë£Œ.")

        elif cmd == "run":
            calc.compute()
            print("ğŸš€ ì—°ì‚° ìˆ˜í–‰ ì™„ë£Œ.")

        elif cmd == "show":
            name = input("ì¶œë ¥í•  ë¸”ë¡ ì´ë¦„: ")
            try:
                print(f"ğŸ“¤ ë¸”ë¡ '{name}':", calc.get_result(name))
            except Exception as e:
                print("âŒ ì˜¤ë¥˜:", e)

        elif cmd == "list":
            print("ğŸ“¦ ì‚¬ìš© ê°€ëŠ¥í•œ ë¸”ë¡ ëª©ë¡:", calc.list_blocks())

        elif cmd == "clear":
            calc.clear_operations()
            print("ğŸ§¹ ì—°ì‚° ì´ˆê¸°í™” ì™„ë£Œ.")

        else:
            print("â“ ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹ì…ë‹ˆë‹¤.")

if __name__ == "__main__":
    run_calculator()






